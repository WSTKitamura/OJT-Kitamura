<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>3D背景付き画像検索＋避けゲー</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        height: 100%;
        font-family: sans-serif;
      }
      #bgCanvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
        display: block;
      }
      .container {
        position: relative;
        z-index: 10;
        max-width: 360px;
        margin: auto;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255, 255, 255, 0.9);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      }
      img {
        max-width: 300px;
        margin-top: 10px;
      }
      #status {
        margin-top: 10px;
        font-weight: bold;
      }
      #status.error {
        color: red;
      }
      #status.success {
        color: green;
      }
      button {
        margin-top: 10px;
        padding: 10px 20px;
        font-size: 1rem;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        background-color: #0066ff;
        color: white;
        transition: background-color 0.3s;
      }
      button:hover {
        background-color: #004bbb;
      }
    </style>
  </head>
  <body>
    <canvas id="bgCanvas"></canvas>

    <div class="container">
      <h1>画像で検索</h1>
      <label for="imageInput">画像を選択してください:</label><br />
      <input
        type="file"
        id="imageInput"
        accept="image/*"
        title="アップロードする画像を選択"
        aria-label="画像ファイルを選択"
        placeholder="ファイルを選択"
      />
      <br />
      <img id="preview" alt="選択された画像プレビュー" />
      <br />
      <button id="uploadButton" onclick="uploadAndSearch()">検索</button>
      <div id="status" aria-live="polite"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
    <script>
      // THREE.js 初期化
      const canvas = document.getElementById("bgCanvas");
      const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setClearColor(0x080808, 1);

      const scene = new THREE.Scene();

      const camera = new THREE.PerspectiveCamera(
        75,
        window.innerWidth / window.innerHeight,
        0.1,
        100
      );
      camera.position.z = 5;

      // ライティング
      scene.add(new THREE.AmbientLight(0xffffff, 0.6));
      const light = new THREE.PointLight(0xffffff, 1.0);
      light.position.set(5, 5, 5);
      scene.add(light);

      // プレイヤー
      const playerGeometry = new THREE.SphereGeometry(0.2, 32, 32);
      const playerMaterial = new THREE.MeshStandardMaterial({
        color: 0x00aaff,
      });
      const player = new THREE.Mesh(playerGeometry, playerMaterial);
      scene.add(player);

      let playerY = 0;
      document.addEventListener("keydown", (e) => {
        if (e.key === "ArrowUp") playerY += 0.3;
        if (e.key === "ArrowDown") playerY -= 0.3;
      });

      // ノーマルマップ読み込み
      const textureLoader = new THREE.TextureLoader();
      const normalMap = textureLoader.load("normal.jpg");

      // 障害物生成
      const obstacles = [];
      function spawnObstacle() {
        const geometry = new THREE.BoxGeometry(0.4, 0.4, 0.4);
        const obstacleMaterial = new THREE.MeshPhysicalMaterial({
          color: 0xffffff,
          metalness: 0.6,
          roughness: 0.3,
          normalMap: normalMap,
          clearcoat: 1.0,
          reflectivity: 1.0,
        });
        const cube = new THREE.Mesh(geometry, obstacleMaterial);
        cube.position.set(
          5,
          (Math.random() - 0.5) * 4,
          (Math.random() - 0.5) * 2
        );
        scene.add(cube);
        obstacles.push(cube);
      }

      setInterval(spawnObstacle, 1000);

      // アニメーションループ
      function animate() {
        requestAnimationFrame(animate);

        player.position.y += (playerY - player.position.y) * 0.2;

        obstacles.forEach((cube) => {
          cube.position.x -= 0.05;
          cube.rotation.x += 0.01;
          cube.rotation.y += 0.01;
        });

        // 衝突判定
        obstacles.forEach((cube) => {
          const dx = player.position.x - cube.position.x;
          const dy = player.position.y - cube.position.y;
          if (Math.abs(dx) < 0.4 && Math.abs(dy) < 0.4) {
            cube.material.color.set(0xff0000); // 衝突時の視覚効果
          }
        });

        renderer.render(scene, camera);
      }
      animate();

      window.addEventListener("resize", () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });

      // アップロードと検索
      const input = document.getElementById("imageInput");
      const preview = document.getElementById("preview");
      const status = document.getElementById("status");
      const button = document.getElementById("uploadButton");

      input.addEventListener("change", () => {
        const file = input.files[0];
        if (file && file.type.startsWith("image/")) {
          const reader = new FileReader();
          reader.onload = (e) => {
            preview.src = e.target.result;
          };
          reader.readAsDataURL(file);
        }
      });

      async function uploadAndSearch() {
        const file = input.files[0];
        if (!file) {
          alert("画像を選択してください。");
          return;
        }

        status.textContent = "検索中...";
        status.className = "";
        button.disabled = true;

        try {
          const response = await fetch(
            "https://brave-hill-0df254e00.6.azurestaticapps.net/api/imageToVector",
            {
              method: "POST",
              headers: { "Content-Type": "application/octet-stream" },
              body: file,
            }
          );

          if (!response.ok)
            throw new Error(`${response.status} - ${await response.text()}`);

          const result = await response.json();
          localStorage.setItem(
            "similarImages",
            JSON.stringify(result.similarImages || [])
          );
          status.textContent = "検索完了、結果ページへ移動します。";
          status.className = "success";
          window.location.href = "results.html";
        } catch (err) {
          status.textContent = "検索に失敗しました: " + err.message;
          status.className = "error";
        } finally {
          button.disabled = false;
        }
      }
    </script>
  </body>
</html>
